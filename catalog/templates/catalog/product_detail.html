{% extends 'catalog/base.html' %}

{% block title %}{{ product.product_name }} - –ö–∞—Ç–∞–ª–æ–≥{% endblock %}
{% block page_title %}{{ product.product_name }}{% endblock %}

{% block content %}
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è Django -->
    {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}" 
                     style="padding: 12px; border-radius: 4px; 
                            {% if message.tags == 'success' %}background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                            {% elif message.tags == 'error' %}background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                            {% else %}background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="product-detail">
        <div style="margin-bottom: 30px;">
            <h2>{{ product.product_name }}</h2>
            
            <div style="margin-bottom: 20px;">
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ product.description }}</p>
                <p><strong>–ë—Ä–µ–Ω–¥:</strong> 
                    {% if product.brand %}
                        <a href="{% url 'catalog:product_list' %}?brand={{ product.brand.slug }}">
                            {{ product.brand.name }}
                        </a>
                    {% else %}
                        –ë–µ–∑ –±—Ä–µ–Ω–¥–∞
                    {% endif %}
                </p>
                <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> 
                    <a href="{% url 'catalog:product_list' %}?category={{ product.category.slug }}">
                        {{ product.category.name }}
                    </a>
                </p>
            </div>
            
            <!-- –ë–ª–æ–∫ —Å —Ü–µ–Ω–æ–π –∏ –Ω–∞–ª–∏—á–∏–µ–º -->
            <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <span style="font-size: 24px; font-weight: bold; color: #e74c3c;">{{ product.price }} —Ä—É–±.</span>
                    </div>
                    <div>
                        <span class="{% if product.in_stock %}in-stock{% else %}out-of-stock{% endif %}" 
                              style="padding: 5px 10px; border-radius: 4px; font-weight: bold;">
                            {% if product.in_stock %}
                                ‚úì –í –Ω–∞–ª–∏—á–∏–∏ ({{ product.stock }} —à—Ç.)
                            {% else %}
                                ‚úó –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <p><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> 
                        <span style="color: #f39c12;">
                            {% if product.average_rating %}
                                {{ product.average_rating }} ‚≠ê
                            {% else %}
                                –ù–µ—Ç –æ—Ü–µ–Ω–æ–∫
                            {% endif %}
                        </span>
                        <span style="color: #666; font-size: 14px;">({{ product.reviews_count }} –æ—Ç–∑—ã–≤–æ–≤)</span>
                    </p>
                    <p><strong>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:</strong> {{ product.created_at|date:"d.m.Y" }}</p>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
                {% if product.in_stock %}
                    <div style="margin-top: 20px;">
                        <!-- –†–ê–ë–û–ß–ê–Ø –§–û–†–ú–ê –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ö–û–†–ó–ò–ù–£ -->
                        <form action="{% url 'cart:add' product.id %}" method="post" 
                              style="display: flex; gap: 10px; align-items: center;">
                            {% csrf_token %}
                            
                            <div style="display: flex; align-items: center;">
                                <label for="quantity" style="margin-right: 10px; font-weight: bold;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                                <input type="number" name="quantity" id="quantity" 
                                       value="1" min="1" max="{{ product.stock }}" 
                                       style="width: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <button type="submit" class="btn-add-to-cart" 
                                    style="background-color: #27ae60; color: white; border: none; padding: 12px 24px; 
                                           border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">
                                <span style="display: inline-flex; align-items: center; gap: 8px;">
                                    üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                                </span>
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8d7da; color: #721c24; 
                                border-radius: 4px; border: 1px solid #f5c6cb; text-align: center;">
                        <p style="margin: 0;">–¢–æ–≤–∞—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
                        <button onclick="notifyWhenAvailable()" 
                                style="margin-top: 10px; padding: 8px 16px; background-color: #6c757d; 
                                       color: white; border: none; border-radius: 4px; cursor: pointer;">
                            –£–≤–µ–¥–æ–º–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏
                        </button>
                    </div>
                {% endif %}
            </div>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <a href="{% url 'catalog:product_list' %}" 
                   style="color: #3498db; text-decoration: none; font-weight: bold; padding: 8px 16px; border: 1px solid #3498db; border-radius: 4px;">
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤
                </a>
                
                {% if user.is_authenticated %}
                <a href="{% url 'users:profile' %}" 
                   style="color: #2ecc71; text-decoration: none; font-weight: bold; padding: 8px 16px; border: 1px solid #2ecc71; border-radius: 4px;">
                    üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
        <div style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 30px;">
            <h3 style="margin-bottom: 20px; color: #333;">–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</h3>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ -->
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #f39c12;">
                            {{ product.average_rating|default:"0.0" }}
                        </div>
                        <div style="font-size: 14px; color: #666;">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 14px; color: #666;">5 –∑–≤–µ–∑–¥</span>
                            <span style="font-size: 14px; color: #666;">{{ product.reviews_count }} –æ—Ç–∑—ã–≤–æ–≤</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
            {% if user.is_authenticated %}
                {% if not user_has_review %}
                <div style="background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 25px; margin-bottom: 30px;">
                    <h4 style="margin-top: 0; margin-bottom: 20px; color: #333;">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>
                    <form method="post" action="{% url 'reviews:add_review' product.id %}">
                        {% csrf_token %}
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: bold;">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</label>
                            <div style="display: flex; gap: 10px;">
                                {% for i in "12345" %}
                                <label style="cursor: pointer;">
                                    <input type="radio" name="rating" value="{{ forloop.counter }}" 
                                           style="display: none;">
                                    <span style="font-size: 24px; color: #ddd; transition: color 0.3s;" 
                                          onmouseover="this.style.color='#f39c12'" 
                                          onmouseout="this.style.color='#ddd'"
                                          onclick="setRating(this)">‚òÖ</span>
                                </label>
                                {% endfor %}
                            </div>
                            <input type="hidden" name="rating_input" id="rating_input" value="5">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="review_text" style="display: block; margin-bottom: 8px; font-weight: bold;">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞:</label>
                            <textarea name="text" id="review_text" rows="4" 
                                      placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞..."
                                      style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                        </div>
                        
                        <button type="submit" 
                                style="background-color: #3498db; color: white; border: none; padding: 12px 24px; 
                                       border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.3s;">
                            üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                        </button>
                    </form>
                </div>
                {% else %}
                <div style="background-color: #e8f4fc; border: 1px solid #b3d7ff; border-radius: 8px; padding: 20px; margin-bottom: 30px; text-align: center;">
                    <p style="margin: 0; color: #0c5460; font-weight: bold;">
                        ‚úÖ –í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
                    </p>
                </div>
                {% endif %}
            {% else %}
            <div style="background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 30px; text-align: center;">
                <p style="margin: 0; color: #666;">
                    <a href="{% url 'users:login' %}" style="color: #3498db; text-decoration: none; font-weight: bold;">
                        –í–æ–π–¥–∏—Ç–µ
                    </a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                </p>
            </div>
            {% endif %}
            
            <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∑—ã–≤—ã -->
            {% if reviews %}
            <div>
                <h4 style="margin-bottom: 20px; color: #333;">–í—Å–µ –æ—Ç–∑—ã–≤—ã ({{ reviews|length }})</h4>
                
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    {% for review in reviews %}
                    <div style="background-color: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    {{ review.user.username }}
                                </div>
                                <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <span style="color: #f39c12; font-size: 16px;">‚òÖ</span>
                                        {% else %}
                                            <span style="color: #ddd; font-size: 16px;">‚òÖ</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                {{ review.created_at|date:"d.m.Y H:i" }}
                                {% if user == review.user %}
                                <form action="{% url 'reviews:delete_review' review.id %}" method="post" style="display: inline; margin-left: 10px;">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤?')"
                                            style="background: none; border: none; color: #e74c3c; cursor: pointer; padding: 0; margin-left: 10px;">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if review.text %}
                        <div style="color: #555; line-height: 1.6;">
                            {{ review.text|linebreaks }}
                        </div>
                        {% else %}
                        <div style="color: #999; font-style: italic;">
                            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Å—Ç–∞–≤–∏–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–∑—ã–≤
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            {% endif %}
        </div>
    </div>
    
    <style>
        .btn-add-to-cart:hover {
            background-color: #219653 !important;
        }
        
        .btn-add-to-cart:active {
            transform: scale(0.98);
        }
        
        .in-stock {
            color: #27ae60;
            background-color: #d5f4e6;
        }
        
        .out-of-stock {
            color: #e74c3c;
            background-color: #fadbd8;
        }
        
        input[type="number"] {
            text-align: center;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3498db !important;
        }
        
        input[type="radio"]:checked + span {
            color: #f39c12 !important;
        }
    </style>
    
    <script>
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞
        function notifyWhenAvailable() {
            const email = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:');
            if (email) {
                alert(`–°–ø–∞—Å–∏–±–æ! –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –Ω–∞ ${email}, –∫–æ–≥–¥–∞ —Ç–æ–≤–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è –≤ –Ω–∞–ª–∏—á–∏–∏.`);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞
        function setRating(star) {
            const stars = star.parentElement.parentElement.querySelectorAll('label');
            const rating = Array.from(stars).indexOf(star.parentElement) + 1;
            const ratingInput = document.getElementById('rating_input');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            stars.forEach((label, index) => {
                const starSpan = label.querySelector('span');
                if (index < rating) {
                    starSpan.style.color = '#f39c12';
                } else {
                    starSpan.style.color = '#ddd';
                }
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
            ratingInput.value = rating;
            
            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏
            const radioButtons = star.parentElement.parentElement.querySelectorAll('input[type="radio"]');
            radioButtons.forEach((radio, index) => {
                radio.checked = (index + 1) === rating;
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('label span[onclick]');
            if (stars.length > 0) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ 5
                const initialRating = 5;
                stars.forEach((star, index) => {
                    if (index < initialRating) {
                        star.style.color = '#f39c12';
                    }
                });
            }
        });
        
        // AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞
        document.querySelectorAll('form[action*="add_review"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const url = this.action;
                
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                        window.location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // –ï—Å–ª–∏ AJAX –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
                    this.submit();
                });
            });
        });
    </script>
{% endblock %}